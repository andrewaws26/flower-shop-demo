<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Todayâ€™s Flower Prices</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600..800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#fff7f2; --bg-accent:#fff1ea; --ink:#2d2724; --rose:#e9a6a6; --leaf:#2f7d4b;
      --petal:#ffddd4; --cream:#fffaf6; --border:#f1d7cf; --shadow:0 6px 18px rgba(196,140,120,.18);
      --gap:12px;
    }
    html, body { height:100%; overflow:hidden; } /* no scroll for kiosk */
    body{
      background:
        radial-gradient(1200px 800px at 100% -10%, #ffe8df 0%, rgba(255,232,223,0) 60%),
        radial-gradient(1200px 800px at -10% 110%, #ffece5 0%, rgba(255,236,229,0) 60%),
        var(--bg);
      color:var(--ink); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .navbar{ background:var(--bg-accent); border-bottom:4px solid var(--rose)!important; }
    .navbar-brand{ font-family:"Playfair Display", ui-serif, Georgia, serif; letter-spacing:.3px; }
    .petal-rule{ height:12px; background:
      radial-gradient(circle at 6px 6px, var(--rose) 4px, transparent 5px) left top/24px 12px repeat-x,
      radial-gradient(circle at 18px 6px, var(--rose) 4px, transparent 5px) left top/24px 12px repeat-x; opacity:.25; }

    /* --- Fullscreen stage for the grid --- */
    #stage{ position:fixed; left:0; right:0; bottom:0; overflow:hidden; padding:12px; }
    #grid{
      display:grid;
      grid-template-columns: repeat(var(--cols, 3), 1fr);
      gap:var(--gap);
      height:100%;
    }

    .category {
      grid-column: 1 / -1;
      justify-self: start;
      font-weight:700; font-size: clamp(.8rem, 1.6vh, 1rem);
      color:#9a6b58; text-transform:uppercase; letter-spacing:.06em;
      margin:.25rem 0 .25rem 0; background:var(--petal);
      padding:.15rem .5rem; border-radius:999px; border:1px solid #f2c8be;
    }

    .card{
      border-radius:18px; background:var(--cream); border:2px solid var(--border);
      box-shadow:var(--shadow); overflow:hidden; /* kiosk: no hover bounce */
    }
    .thumb-wrap{ width:100%; background:#fff1ea; }
    .thumb{
      display:block; width:100%; height:100%;
      object-fit:cover; object-position:center;
    }

    .card-body{ display:flex; flex-direction:column; padding:.6rem .8rem; }
    .card-title{
      font-family:"Playfair Display", ui-serif, Georgia, serif;
      font-weight:700; margin:0 0 .15rem 0;
      font-size: clamp(.9rem, 2.0vh, 1.25rem);
      line-height:1.1;
    }
    .card-price{
      color:var(--leaf); font-weight:800; letter-spacing:.2px;
      font-size: clamp(.9rem, 1.8vh, 1.15rem);
    }
    .card-note{ margin-top:.25rem; color:#7b5c53; font-size: clamp(.8rem, 1.6vh, 1rem); }
    .offline{
      position:fixed; right:1rem; bottom:1rem; display:none; background:#fff0e8;
      border:2px solid #f3c2b2; color:#7b5c53; box-shadow:var(--shadow);
      font-size: clamp(.75rem, 1.5vh, .95rem);
    }
  </style>
</head>
<body>

  <nav class="navbar mb-0">
    <div class="container-fluid py-2">
      <span class="navbar-brand mb-0 h1">ðŸŒ¿ Blooms & Stems â€” Todayâ€™s Flowers</span>
      <span class="text-muted" id="updated" aria-live="polite">Loadingâ€¦</span>
    </div>
    <div class="petal-rule w-100"></div>
  </nav>

  <!-- Fullscreen stage under the header -->
  <div id="stage">
    <div id="grid"></div>
  </div>

  <div id="offline" class="alert offline" role="status">Offline â€” showing last saved prices</div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /* ====== CONFIG ====== */
  const SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFbE7BWzH5hTWoCtlK_a0mw8RKsBOAJs_-2rbudUkyv-uXUSwkJh03EdqnW-5N-hqtMrHCjm4BYmRe/pub?output=csv";
  const REFRESH_MS   = 60 * 1000;
  const CACHE_TTL_MS = 6 * 60 * 60 * 1000;
  const BASE_IMAGE_PATH = "/images/";

  /* ====== ELEMENTS ====== */
  const grid = document.getElementById('grid');
  const stage = document.getElementById('stage');
  const updated = document.getElementById('updated');
  const offlineBadge = document.getElementById('offline');

  /* ===== CSV PARSER ===== */
  function csvToRows(text) {
    return text.trim().split(/\r?\n/).map(line => {
      const out=[]; let cur='', inQ=false;
      for (const c of line){
        if (c === '"'){ inQ = !inQ; continue; }
        if (c === ',' && !inQ){ out.push(cur); cur=''; } else { cur += c; }
      }
      out.push(cur);
      return out.map(s => s.trim());
    });
  }

  /* ===== HELPERS ===== */
  function groupBy(arr, key) {
    const m = new Map();
    for (const row of arr) {
      const k = row[key] || "";
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(row);
    }
    return m;
  }
  function relativeTime(t){
    const s = Math.floor((Date.now() - t) / 1000);
    if (s < 60) return `${s}s ago`;
    const m = Math.floor(s / 60);
    if (m < 60) return `${m}m ago`;
    return `${Math.floor(m / 60)}h ago`;
  }
  function looksLikeFilename(v){
    return typeof v === 'string' && v.length && !/^https?:\/\//i.test(v) && !v.startsWith('/');
  }
  function safeUrl(u){
    if (!u) return '';
    const trimmed = u.trim();
    if (trimmed.startsWith('javascript:')) return '';
    return trimmed;
  }
  function placeholderSVG(name){
    const text = encodeURIComponent(name || 'Flower');
    const bg = encodeURIComponent('#fff1ea');
    const fg = encodeURIComponent('#9a6b58');
    return `data:image/svg+xml;utf8,`+
      `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>`+
      `<rect width='100%' height='100%' fill='${bg}'/>`+
      `<text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'`+
      ` font-family='Playfair Display, Georgia, serif' font-size='44' fill='${fg}'>${text}</text>`+
      `</svg>`;
  }
  function getImageSrc(it){
    const fields=['Image URL','Image','Photo']; let v='';
    for (const f of fields){ if (it[f]) { v = it[f]; break; } }
    if (looksLikeFilename(v)) return BASE_IMAGE_PATH + v;
    const url = safeUrl(v);
    return url || placeholderSVG(it['Item'] || 'Flower');
  }

  /* ===== FIT GRID TO SCREEN (no scroll) ===== */
  function setStageHeight(){
    // position stage immediately below navbar
    const nav = document.querySelector('.navbar');
    const navBottom = nav.getBoundingClientRect().bottom;
    stage.style.top = `${navBottom}px`;
  }
  function layoutGrid(totalCards){
    // choose square-ish grid
    const cols = Math.ceil(Math.sqrt(totalCards || 1));
    const rows = Math.ceil((totalCards || 1) / cols);
    document.documentElement.style.setProperty('--cols', cols);

    // compute per-card height
    const gapPx = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 12;
    const h = stage.clientHeight;
    const cardH = Math.floor((h - gapPx * (rows - 1)) / rows);

    // set heights on cards & image areas
    const cards = grid.querySelectorAll('.card');
    const imgs  = grid.querySelectorAll('.thumb-wrap');
    cards.forEach(c => c.style.height = `${cardH}px`);
    imgs.forEach(i => i.style.height = `${Math.max(0.45 * cardH, 120)}px`); // ~45% image area
  }

  /* ===== RENDER ===== */
  function render(items) {
    grid.innerHTML = '';

    // Build a flat array of rows we will actually render (skip out-of-stock)
    const visible = items.filter(it => (it['In Stock'] || '').toString().toLowerCase() !== 'false');

    // Optional: show category labels
    const byCat = groupBy(visible, 'Category');
    const flat = [];
    for (const [cat, rows] of byCat) {
      if (cat) {
        const label = document.createElement('div');
        label.className = 'category';
        label.textContent = cat;
        grid.appendChild(label);
      }
      for (const it of rows) {
        flat.push(it);
        const card = document.createElement('div');
        card.className = 'card';

        const imgWrap = document.createElement('div');
        imgWrap.className = 'thumb-wrap';
        const img = document.createElement('img');
        img.className = 'thumb';
        img.alt = (it['Item'] || 'Flower') + ' image';
        img.loading = 'eager'; // kiosk: eager to avoid late pop-in
        img.src = getImageSrc(it);
        imgWrap.appendChild(img);

        const body = document.createElement('div');
        body.className = 'card-body';

        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = it['Item'] || '';

        const price = document.createElement('div');
        price.className = 'card-price';
        price.textContent = it['Price'] || '';

        body.appendChild(title);
        body.appendChild(price);

        const noteVal = it['Notes/Emoji'];
        if (noteVal) {
          const note = document.createElement('div');
          note.className = 'card-note';
          note.textContent = noteVal;
          body.appendChild(note);
        }

        card.appendChild(imgWrap);
        card.appendChild(body);
        grid.appendChild(card);
      }
    }

    // After DOM is ready, size it to the viewport
    setStageHeight();
    layoutGrid(grid.querySelectorAll('.card').length);
  }

  /* ===== CACHE ===== */
  function loadCached() {
    try {
      const cached = JSON.parse(localStorage.getItem('lastData') || 'null');
      if (!cached) return null;
      if (Date.now() - cached.t > CACHE_TTL_MS) return null;
      return cached;
    } catch { return null; }
  }
  function saveCache(items) {
    try { localStorage.setItem('lastData', JSON.stringify({ t: Date.now(), items })); } catch {}
  }

  /* ===== FETCH & UPDATE LOOP ===== */
  let lastUpdateT = Date.now();
  setInterval(() => { updated.textContent = `Updated ${relativeTime(lastUpdateT)}`; }, 15000);

  async function fetchAndRender() {
    try {
      const res = await fetch(SHEET_CSV_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(res.statusText);
      const text = await res.text();
      const rows = csvToRows(text);
      const headers = rows[0];
      const items = rows.slice(1).map(r =>
        Object.fromEntries(headers.map((h, i) => [h, r[i] ?? '']))
      );

      render(items);
      lastUpdateT = Date.now();
      updated.textContent = `Updated ${new Date(lastUpdateT).toLocaleString()}`;
      saveCache(items);
      offlineBadge.style.display = 'none';
    } catch (e) {
      const cached = loadCached();
      if (cached) {
        render(cached.items);
        updated.textContent = `Offline â€” last update ${new Date(cached.t).toLocaleString()}`;
        offlineBadge.style.display = 'block';
      } else {
        updated.textContent = 'Failed to load data';
      }
    }
  }

  // Size on load & whenever the window changes (e.g., Pi switches resolution)
  window.addEventListener('resize', () => {
    setStageHeight();
    layoutGrid(grid.querySelectorAll('.card').length);
  });

  fetchAndRender();
  setInterval(fetchAndRender, REFRESH_MS);
  </script>
</body>
</html>
