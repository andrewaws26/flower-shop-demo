<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Todayâ€™s Flower Prices</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Optional heading font (elegant but readable) -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600..800&display=swap" rel="stylesheet">

  <style>
    /* ===== Flower Shop Theme (light, pastel) ===== */
    :root{
      --bg: #fff7f2;            /* peachy paper */
      --bg-accent: #fff1ea;     /* header tint */
      --ink: #2d2724;           /* warm dark text */
      --rose: #e9a6a6;          /* rose pink accent */
      --leaf: #2f7d4b;          /* leafy green for prices */
      --petal: #ffddd4;         /* soft petal */
      --cream: #fffaf6;         /* card background */
      --border: #f1d7cf;        /* card border */
      --shadow: 0 6px 18px rgba(196, 140, 120, .18);
    }

    html, body { height: 100%; }
    body {
      background:
        radial-gradient(1200px 800px at 100% -10%, #ffe8df 0%, rgba(255,232,223,0) 60%),
        radial-gradient(1200px 800px at -10% 110%, #ffece5 0%, rgba(255,236,229,0) 60%),
        var(--bg);
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    /* Header: soft tint + petal divider */
    .navbar {
      background: linear-gradient(0deg, var(--bg-accent), var(--bg-accent));
      border-bottom: 4px solid var(--rose) !important;
    }
    .navbar-brand {
      font-family: "Playfair Display", ui-serif, Georgia, serif;
      letter-spacing: .3px;
    }
    .petal-rule {
      height: 12px;
      background:
        radial-gradient(circle at 6px 6px, var(--rose) 4px, transparent 5px) left top / 24px 12px repeat-x,
        radial-gradient(circle at 18px 6px, var(--rose) 4px, transparent 5px) left top / 24px 12px repeat-x;
      opacity: .25;
    }

    /* Grid & cards */
    .category {
      font-weight: 700;
      font-size: .9rem;
      color: #9a6b58;
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-top: 1.25rem;
      display: inline-block;
      background: var(--petal);
      padding: .25rem .6rem;
      border-radius: 999px;
      border: 1px solid #f2c8be;
    }
    .card {
      border-radius: 18px;
      background: var(--cream);
      border: 2px solid var(--border);
      box-shadow: var(--shadow);
      transition: transform .08s ease, box-shadow .12s ease;
      overflow: hidden; /* ensure rounded corners clip the image */
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(196,140,120,.22); }

    .thumb-wrap {
      width: 100%;
      background: #fff1ea;
    }
    .thumb {
      display: block;
      width: 100%;
      height: auto;
      aspect-ratio: 4 / 3;      /* modern browsers */
      object-fit: cover;
      object-position: center;
    }
    /* Fallback if aspect-ratio unsupported (older browsers) */
    .thumb-fallback {
      position: relative;
      width: 100%;
      padding-top: 75%;
      background: #fff1ea;
      overflow: hidden;
    }
    .thumb-fallback > img {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover; object-position: center;
    }

    .card-title {
      font-family: "Playfair Display", ui-serif, Georgia, serif;
      font-weight: 700;
      font-size: clamp(1.05rem, 2.6vw, 1.25rem);
      margin-bottom: .25rem;
    }
    .card-price {
      color: var(--leaf);
      font-weight: 800;
      letter-spacing: .2px;
      font-size: clamp(1rem, 2.4vw, 1.15rem);
    }
    .card-note {
      margin-top: .35rem;
      color: #7b5c53;
      font-size: .98rem;
    }

    .offline {
      position: fixed;
      right: 1rem;
      bottom: 1rem;
      display: none;
      background: #fff0e8;
      border: 2px solid #f3c2b2;
      color: #7b5c53;
      box-shadow: var(--shadow);
    }

    @media (max-width: 480px){
      .card { border-radius: 16px; }
    }
  </style>
</head>
<body class="pb-5">

  <nav class="navbar mb-0">
    <div class="container-fluid py-2">
      <span class="navbar-brand mb-0 h1">ðŸŒ¿ Blooms & Stems â€” Todayâ€™s Flowers</span>
      <span class="text-muted" id="updated" aria-live="polite">Loadingâ€¦</span>
    </div>
    <div class="petal-rule w-100"></div>
  </nav>

  <main class="container py-3">
    <div id="grid" class="row g-3"></div>
  </main>

  <div id="offline" class="alert offline" role="status">
    Offline â€” showing last saved prices
  </div>

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /* ====== CONFIG ====== */
  const SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFbE7BWzH5hTWoCtlK_a0mw8RKsBOAJs_-2rbudUkyv-uXUSwkJh03EdqnW-5N-hqtMrHCjm4BYmRe/pub?output=csv";
  const REFRESH_MS   = 60 * 1000;            // refresh every 60s
  const CACHE_TTL_MS = 6 * 60 * 60 * 1000;   // 6 hours

  /* Optional: base folder for local images on GitHub Pages
     If your sheet has filenames (e.g. "rose.jpg") instead of full URLs,
     put those files in /images and set BASE_IMAGE_PATH = "/images/". */
  const BASE_IMAGE_PATH = "/images/"; // leave as-is or change; used only when value looks like a filename

  /* ====== ELEMENTS ====== */
  const grid = document.getElementById('grid');
  const updated = document.getElementById('updated');
  const offlineBadge = document.getElementById('offline');

  /* ===== CSV PARSER ===== */
  function csvToRows(text) {
    return text.trim().split(/\r?\n/).map(line => {
      const out = []; let cur = '', inQ = false;
      for (const c of line) {
        if (c === '"') { inQ = !inQ; continue; }
        if (c === ',' && !inQ) { out.push(cur); cur = ''; } else { cur += c; }
      }
      out.push(cur);
      return out.map(s => s.trim());
    });
  }

  /* ===== HELPERS ===== */
  function groupBy(arr, key) {
    const m = new Map();
    for (const row of arr) {
      const k = row[key] || "";
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(row);
    }
    return m;
  }
  function relativeTime(t){
    const s = Math.floor((Date.now() - t) / 1000);
    if (s < 60) return `${s}s ago`;
    const m = Math.floor(s / 60);
    if (m < 60) return `${m}m ago`;
    return `${Math.floor(m / 60)}h ago`;
  }
  function looksLikeFilename(v){
    return typeof v === 'string' && v.length && !/^https?:\/\//i.test(v) && !v.startsWith('/');
  }
  function safeUrl(u){
    if (!u) return '';
    const trimmed = u.trim();
    if (trimmed.startsWith('javascript:')) return '';
    return trimmed;
  }
  function placeholderSVG(name){
    const text = encodeURIComponent(name || 'Flower');
    const bg = encodeURIComponent('#fff1ea');
    const fg = encodeURIComponent('#9a6b58');
    return `data:image/svg+xml;utf8,` +
      `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>` +
      `<rect width='100%' height='100%' fill='${bg}'/>` +
      `<text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' ` +
      `font-family='Playfair Display, Georgia, serif' font-size='44' fill='${fg}'>${text}</text>` +
      `</svg>`;
  }
  function getImageSrc(it){
    const fields = ['Image URL', 'Image', 'Photo'];
    let v = '';
    for (const f of fields){
      if (it[f]) { v = it[f]; break; }
    }
    if (looksLikeFilename(v)) return BASE_IMAGE_PATH + v;
    const url = safeUrl(v);
    return url || placeholderSVG(it['Item'] || 'Flower');
  }

  /* ===== SAFE RENDER (no innerHTML from CSV fields) ===== */
  function render(items) {
    grid.innerHTML = '';
    const byCat = groupBy(items, 'Category');

    for (const [cat, rows] of byCat) {
      if (cat) {
        const wrap = document.createElement('div');
        wrap.className = 'col-12';
        const pill = document.createElement('span');
        pill.className = 'category';
        pill.textContent = cat;
        wrap.appendChild(pill);
        grid.appendChild(wrap);
      }

      for (const it of rows) {
        if ((it['In Stock'] || '').toString().toLowerCase() === 'false') continue;

        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-md-4 col-lg-3';

        const card = document.createElement('div');
        card.className = 'card h-100';

        /* ---- image block ---- */
        const imgSrc = getImageSrc(it);
        // aspect-ratio supported path
        const img = document.createElement('img');
        img.className = 'thumb';
        img.loading = 'lazy';
        img.alt = (it['Item'] || 'Flower') + ' image';
        img.src = imgSrc;

        const thumbWrap = document.createElement('div');
        thumbWrap.className = 'thumb-wrap';
        thumbWrap.appendChild(img);

        card.appendChild(thumbWrap);

        /* ---- body ---- */
        const body = document.createElement('div');
        body.className = 'card-body d-flex flex-column';

        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = it['Item'] || '';

        const price = document.createElement('div');
        price.className = 'card-price';
        price.textContent = it['Price'] || '';

        body.appendChild(title);
        body.appendChild(price);

        const noteVal = it['Notes/Emoji'];
        if (noteVal) {
          const note = document.createElement('div');
          note.className = 'card-note';
          note.textContent = noteVal;
          body.appendChild(note);
        }

        card.appendChild(body);
        col.appendChild(card);
        grid.appendChild(col);
      }
    }
  }

  /* ===== CACHE HELPERS ===== */
  function loadCached() {
    try {
      const cached = JSON.parse(localStorage.getItem('lastData') || 'null');
      if (!cached) return null;
      if (Date.now() - cached.t > CACHE_TTL_MS) return null;
      return cached;
    } catch { return null; }
  }
  function saveCache(items) {
    try { localStorage.setItem('lastData', JSON.stringify({ t: Date.now(), items })); }
    catch {}
  }

  /* ===== FETCH & UPDATE LOOP ===== */
  let lastUpdateT = Date.now();
  setInterval(() => { updated.textContent = `Updated ${relativeTime(lastUpdateT)}`; }, 15000);

  async function fetchAndRender() {
    try {
      const res = await fetch(SHEET_CSV_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(res.statusText);
      const text = await res.text();
      const rows = csvToRows(text);
      const headers = rows[0];
      const items = rows.slice(1).map(r =>
        Object.fromEntries(headers.map((h, i) => [h, r[i] ?? '']))
      );

      render(items);
      lastUpdateT = Date.now();
      updated.textContent = `Updated ${new Date(lastUpdateT).toLocaleString()}`;
      saveCache(items);
      offlineBadge.style.display = 'none';
    } catch (e) {
      const cached = loadCached();
      if (cached) {
        render(cached.items);
        updated.textContent = `Offline â€” last update ${new Date(cached.t).toLocaleString()}`;
        offlineBadge.style.display = 'block';
      } else {
        updated.textContent = 'Failed to load data';
      }
    }
  }

  fetchAndRender();
  setInterval(fetchAndRender, REFRESH_MS);
  </script>
</body>
</html>
