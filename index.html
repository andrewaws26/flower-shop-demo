<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Todayâ€™s Flower Prices</title>

  <!-- Bootstrap (reset & utilities) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Elegant heading font -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600..800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#fff7f2; --bg-accent:#fff1ea; --ink:#2d2724; --rose:#e9a6a6; --leaf:#2f7d4b;
      --cream:#fffdfb; --border:#efd6cc; --shadow:0 6px 18px rgba(196,140,120,.16);
      --gap:12px;
    }

    html, body { height:100%; overflow:hidden; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 100% -10%, #ffe8df 0%, rgba(255,232,223,0) 60%),
        radial-gradient(1200px 800px at -10% 110%, #ffece5 0%, rgba(255,236,229,0) 60%),
        var(--bg);
      color:var(--ink); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      user-select:none; cursor:none; /* pure kiosk display */
    }

    /* Header */
    .navbar{ background:var(--bg-accent); border-bottom:3px solid var(--rose)!important; }
    .navbar-brand{ font-family:"Playfair Display", ui-serif, Georgia, serif; letter-spacing:.3px; }
    .petal-rule{ height:10px; background:
      radial-gradient(circle at 6px 5px, var(--rose) 4px, transparent 5px) left top/22px 10px repeat-x,
      radial-gradient(circle at 17px 5px, var(--rose) 4px, transparent 5px) left top/22px 10px repeat-x; opacity:.22; }

    /* Stage */
    #stage{ position:fixed; left:0; right:0; bottom:0; overflow:hidden; padding:10px; }
    #grid{
      display:grid;
      grid-template-columns: repeat(var(--cols, 3), 1fr);
      gap:var(--gap);
      height:100%;
    }

    /* Card */
    .card{
      border-radius:16px; background:var(--cream); border:1px solid var(--border);
      box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column;
    }
    .thumb-wrap{ width:100%; background:#fff3ee; flex:0 0 auto; }
    .thumb{ width:100%; height:100%; object-fit:cover; object-position:center; display:block; }

    .card-body{
      display:grid; grid-template-rows:auto auto 1fr; row-gap:.25rem;
      padding:.5rem .6rem .55rem .6rem; min-height:0;
    }
    .card-title{
      font-family:"Playfair Display", ui-serif, Georgia, serif; font-weight:700; margin:0;
      line-height:1.1; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical;
      letter-spacing:.2px;
    }
    .price-row{ display:flex; align-items:center; gap:.4rem; }
    .card-price{
      color:var(--leaf); font-weight:800; letter-spacing:.2px;
      padding:.08rem .45rem; border-radius:999px; background:#eaf6ee; border:1px solid #cfe7d7;
      display:inline-block;
    }
    .mini-cat{
      color:#8b6a60; font-weight:700; text-transform:uppercase; letter-spacing:.06em;
      font-size:.82em; opacity:.85;
    }
    .card-note{
      margin-top:.1rem; color:#7b5c53; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical;
    }

    .offline{
      position:fixed; right:1rem; bottom:1rem; display:none; background:#fff0e8;
      border:1px solid #f3c2b2; color:#7b5c53; box-shadow:var(--shadow);
      padding:.35rem .6rem; border-radius:10px; font-size:.95rem;
    }

    /* Count (debug/comfort) */
    #count{ font-size:.95rem; color:#6c5a52; margin-left:.75rem; }
  </style>
</head>
<body>
  <nav class="navbar mb-0">
    <div class="container-fluid py-2">
      <span class="navbar-brand mb-0 h1">ðŸŒ¿ Blooms & Stems â€” Todayâ€™s Flowers</span>
      <span class="text-muted" id="updated" aria-live="polite">Loadingâ€¦</span>
      <span id="count" aria-live="polite"></span>
    </div>
    <div class="petal-rule w-100"></div>
  </nav>

  <div id="stage"><div id="grid"></div></div>

  <div id="offline" class="alert offline" role="status">Offline â€” showing last saved prices</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /* ====== CONFIG ====== */
  const SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFbE7BWzH5hTWoCtlK_a0mw8RKsBOAJs_-2rbudUkyv-uXUSwkJh03EdqnW-5N-hqtMrHCjm4BYmRe/pub?output=csv";
  const REFRESH_MS   = 60 * 1000;          // refresh every 60s
  const CACHE_TTL_MS = 6 * 60 * 60 * 1000; // 6 hours
  const BASE_IMAGE_PATH = "images/";      // filenames like "rose.jpg" resolve here

  /* ====== ELEMENTS ====== */
  const grid = document.getElementById('grid');
  const stage = document.getElementById('stage');
  const updated = document.getElementById('updated');
  const offlineBadge = document.getElementById('offline');
  const count = document.getElementById('count');

  /* ===== CSV PARSER (handles quotes) ===== */
  function csvToRows(text) {
    return text.trim().split(/\r?\n/).map(line => {
      const out=[]; let cur='', inQ=false;
      for (let i=0;i<line.length;i++){
        const c = line[i];
        if (c === '"'){
          const next = line[i+1];
          if (inQ && next === '"'){ cur+='"'; i++; continue; } // escaped quote
          inQ = !inQ; continue;
        }
        if (c === ',' && !inQ){ out.push(cur); cur=''; } else { cur += c; }
      }
      out.push(cur);
      return out.map(s => s.trim());
    });
  }

  /* ===== HELPERS ===== */
  function relativeTime(t){
    const s = Math.floor((Date.now() - t) / 1000);
    if (s < 60) return `${s}s ago`;
    const m = Math.floor(s / 60);
    if (m < 60) return `${m}m ago`;
    return `${Math.floor(m / 60)}h ago`;
  }
  function looksLikeFilename(v){
    return typeof v === 'string' && v.length && !/^https?:\/\//i.test(v) && !v.startsWith('/');
  }
  function safeUrl(u){
    if (!u) return '';
    const trimmed = u.trim();
    if (/^javascript:/i.test(trimmed)) return '';
    return trimmed;
  }
  function placeholderSVG(name){
    const text = encodeURIComponent(name || 'Flower');
    const bg = encodeURIComponent('#fff3ee');
    const fg = encodeURIComponent('#9a6b58');
    return `data:image/svg+xml;utf8,`+
      `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>`+
      `<rect width='100%' height='100%' fill='${bg}'/>`+
      `<text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'`+
      ` font-family='Playfair Display, Georgia, serif' font-size='44' fill='${fg}'>${text}</text>`+
      `</svg>`;
  }
  function getImageSrc(it){
    const fields=['Image URL','Image','Photo']; let v='';
    for (const f of fields){ if (it[f]) { v = it[f]; break; } }
    if (looksLikeFilename(v)) return BASE_IMAGE_PATH + v;
    const url = safeUrl(v);
    return url || placeholderSVG(it['Item'] || 'Flower');
  }

  /* ===== KIOSK LAYOUT ===== */

  // Place stage below navbar
  function setStageTop(){
    const nav = document.querySelector('.navbar');
    const navBottom = nav.getBoundingClientRect().bottom;
    stage.style.top = `${navBottom}px`;
  }

  // Aspect-ratioâ€“aware rows Ã— cols chooser
  const TARGET_AR = 0.85; // prefer slightly wider cards; adjust 0.8â€“1.0 to taste
  function chooseGrid(n, W, H, gap){
    let best = null;
    for (let rows = 1; rows <= n; rows++){
      const cols = Math.ceil(n / rows);
      const cw = (W - gap * (cols - 1)) / cols;
      const ch = (H - gap * (rows - 1)) / rows;
      if (cw <= 0 || ch <= 0) continue;

      const ar = cw / ch;
      const area = cw * ch;
      const penalty = Math.abs(ar - TARGET_AR);
      const score = area / (1 + 2.2 * penalty);
      if (!best || score > best.score) best = {rows, cols, cw, ch, ar, score};
    }
    return best;
  }

  function layoutGrid(){
    setStageTop();
    const W = stage.clientWidth;
    const H = stage.clientHeight;
    const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 12;

    const cards = grid.querySelectorAll('.card');
    const n = cards.length || 1;
    const g = chooseGrid(n, W, H, gap);

    document.documentElement.style.setProperty('--cols', g.cols);

    // Card height and image height (~58% of card for more visual emphasis)
    const cardH = Math.floor(g.ch);
    const imgH  = Math.max(120, Math.floor(cardH * 0.58)); // MORE IMAGE SPACE
    cards.forEach(c => c.style.height = `${cardH}px`);
    grid.querySelectorAll('.thumb-wrap').forEach(w => w.style.height = `${imgH}px`);

    // Typography scales with remaining content space; tighter bounds for neatness
    const titleSize = Math.max(14, Math.min(24, Math.floor(cardH * 0.08)));
    const priceSize = Math.max(13, Math.min(20, Math.floor(cardH * 0.07)));
    const noteSize  = Math.max(12, Math.min(16, Math.floor(cardH * 0.055)));

    grid.querySelectorAll('.card-title').forEach(el => el.style.fontSize = `${titleSize}px`);
    grid.querySelectorAll('.card-price').forEach(el => el.style.fontSize = `${priceSize}px`);
    grid.querySelectorAll('.mini-cat').forEach(el => el.style.fontSize = `${Math.max(11, priceSize - 3)}px`);
    grid.querySelectorAll('.card-note').forEach(el => el.style.fontSize = `${noteSize}px`);
  }

  /* ===== RENDER ===== */
  function render(items) {
    grid.innerHTML = '';

    // Show everything with a non-empty Item unless clearly OUT of stock
    const outFlags = new Set(['false','no','0','n','out','sold out','sold-out','oos']);
    const visible = items.filter(it => {
      const name = String(it['Item'] || '').trim();
      if (!name) return false; // skip truly blank rows
      const stockRaw = String(it['In Stock'] ?? '').trim().toLowerCase();
      return !outFlags.has(stockRaw);
    });

    for (const it of visible) {
      const card = document.createElement('div');
      card.className = 'card';

      const imgWrap = document.createElement('div');
      imgWrap.className = 'thumb-wrap';
      const img = document.createElement('img');
      img.className = 'thumb';
      img.alt = (it['Item'] || 'Flower') + ' image';
      img.loading = 'eager';
      img.src = getImageSrc(it);
      imgWrap.appendChild(img);

      const body = document.createElement('div');
      body.className = 'card-body';

      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = it['Item'] || '';

      const priceRow = document.createElement('div');
      priceRow.className = 'price-row';

      const price = document.createElement('div');
      price.className = 'card-price';
      price.textContent = it['Price'] || '';

      const cat = String(it['Category'] || '').trim();
      if (cat) {
        const mini = document.createElement('span');
        mini.className = 'mini-cat';
        mini.textContent = cat;
        priceRow.appendChild(mini);
      }
      priceRow.appendChild(price);

      const noteVal = it['Notes/Emoji'];
      if (noteVal) {
        const note = document.createElement('div');
        note.className = 'card-note';
        note.textContent = noteVal;
        body.appendChild(title);
        body.appendChild(priceRow);
        body.appendChild(note);
      } else {
        body.appendChild(title);
        body.appendChild(priceRow);
      }

      card.appendChild(imgWrap);
      card.appendChild(body);
      grid.appendChild(card);
    }

    count.textContent = `â€¢ ${visible.length} items`;
    layoutGrid();
  }

  /* ===== CACHE ===== */
  function loadCached() {
    try {
      const cached = JSON.parse(localStorage.getItem('lastData') || 'null');
      if (!cached) return null;
      if (Date.now() - cached.t > CACHE_TTL_MS) return null;
      return cached;
    } catch { return null; }
  }
  function saveCache(items) {
    try { localStorage.setItem('lastData', JSON.stringify({ t: Date.now(), items })); } catch {}
  }

  /* ===== FETCH & UPDATE LOOP ===== */
  let lastUpdateT = Date.now();
  setInterval(() => { updated.textContent = `Updated ${relativeTime(lastUpdateT)}`; }, 15000);

  async function fetchAndRender() {
    try {
      const res = await fetch(SHEET_CSV_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(res.statusText);
      const text = await res.text();
      const rows = csvToRows(text);
      const headers = rows[0];
      const items = rows.slice(1).map(r =>
        Object.fromEntries(headers.map((h, i) => [h, r[i] ?? '']))
      );

      render(items);
      lastUpdateT = Date.now();
      updated.textContent = `Updated ${new Date(lastUpdateT).toLocaleString()}`;
      saveCache(items);
      offlineBadge.style.display = 'none';
    } catch {
      const cached = loadCached();
      if (cached) {
        render(cached.items);
        updated.textContent = `Offline â€” last update ${new Date(cached.t).toLocaleString()}`;
        offlineBadge.style.display = 'block';
      } else {
        updated.textContent = 'Failed to load data';
      }
    }
  }

  window.addEventListener('resize', layoutGrid);
  fetchAndRender();
  setInterval(fetchAndRender, REFRESH_MS);
  </script>
</body>
</html>