<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Todayâ€™s Flower Prices</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background-color:#fffaf7; }
    .category { font-weight:600; margin-top:1rem; color:#9a6b58; text-transform:uppercase; }
    .card { border-radius:1rem; }
    .offline { position:fixed; right:1rem; bottom:1rem; display:none; }
  </style>
</head>
<body class="pb-5">

  <nav class="navbar bg-light border-bottom mb-3">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">ðŸŒ¸ Todayâ€™s Flowers</span>
      <span class="text-muted" id="updated" aria-live="polite">Loadingâ€¦</span>
    </div>
  </nav>

  <main class="container">
    <div id="grid" class="row g-3"></div>
  </main>

  <div id="offline" class="alert alert-warning offline" role="status">
    Offline â€” showing last saved prices
  </div>

  <!-- Bootstrap Bundle JS (optional: for components) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /* ====== CONFIG ====== */
  const SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFbE7BWzH5hTWoCtlK_a0mw8RKsBOAJs_-2rbudUkyv-uXUSwkJh03EdqnW-5N-hqtMrHCjm4BYmRe/pub?output=csv";
  const REFRESH_MS   = 60 * 1000;            // refresh every 60s
  const CACHE_TTL_MS = 6 * 60 * 60 * 1000;   // 6 hours

  /* ====== ELEMENTS ====== */
  const grid = document.getElementById('grid');
  const updated = document.getElementById('updated');
  const offlineBadge = document.getElementById('offline');

  /* ===== CSV PARSER (handles quoted commas) ===== */
  function csvToRows(text) {
    return text.trim().split(/\r?\n/).map(line => {
      const out = []; let cur = '', inQ = false;
      for (const c of line) {
        if (c === '"') { inQ = !inQ; continue; }
        if (c === ',' && !inQ) { out.push(cur); cur = ''; } else { cur += c; }
      }
      out.push(cur);
      return out.map(s => s.trim());
    });
  }

  /* ===== HELPERS ===== */
  function groupBy(arr, key) {
    const m = new Map();
    for (const row of arr) {
      const k = row[key] || "";
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(row);
    }
    return m;
  }
  function relativeTime(t){
    const s = Math.floor((Date.now() - t) / 1000);
    if (s < 60) return `${s}s ago`;
    const m = Math.floor(s / 60);
    if (m < 60) return `${m}m ago`;
    return `${Math.floor(m / 60)}h ago`;
  }

  /* ===== SAFE RENDER (no innerHTML from CSV fields) ===== */
  function render(items) {
    grid.innerHTML = '';
    const byCat = groupBy(items, 'Category');

    for (const [cat, rows] of byCat) {
      if (cat) {
        const catCol = document.createElement('div');
        catCol.className = 'category col-12';
        catCol.textContent = cat; // SAFE
        grid.appendChild(catCol);
      }

      for (const it of rows) {
        if ((it['In Stock'] || '').toString().toLowerCase() === 'false') continue;

        const col = document.createElement('div');
        col.className = 'col-sm-6 col-md-4 col-lg-3';

        const card = document.createElement('div');
        card.className = 'card shadow-sm h-100';

        const body = document.createElement('div');
        body.className = 'card-body d-flex flex-column justify-content-between';

        const title = document.createElement('h5');
        title.className = 'card-title';
        title.textContent = it['Item'] || ''; // SAFE

        const price = document.createElement('h6');
        price.className = 'card-subtitle mb-2 text-muted';
        price.textContent = it['Price'] || ''; // SAFE

        body.appendChild(title);
        body.appendChild(price);

        const noteVal = it['Notes/Emoji'];
        if (noteVal) {
          const note = document.createElement('p');
          note.className = 'card-text mt-2';
          note.textContent = noteVal; // SAFE
          body.appendChild(note);
        }

        card.appendChild(body);
        col.appendChild(card);
        grid.appendChild(col);
      }
    }
  }

  /* ===== CACHE HELPERS ===== */
  function loadCached() {
    try {
      const cached = JSON.parse(localStorage.getItem('lastData') || 'null');
      if (!cached) return null;
      if (Date.now() - cached.t > CACHE_TTL_MS) return null;
      return cached;
    } catch { return null; }
  }
  function saveCache(items) {
    try { localStorage.setItem('lastData', JSON.stringify({ t: Date.now(), items })); }
    catch {}
  }

  /* ===== FETCH & UPDATE LOOP ===== */
  let lastUpdateT = Date.now();
  setInterval(() => { updated.textContent = `Updated ${relativeTime(lastUpdateT)}`; }, 15000);

  async function fetchAndRender() {
    try {
      const res = await fetch(SHEET_CSV_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(res.statusText);
      const text = await res.text();
      const rows = csvToRows(text);
      const headers = rows[0];
      const items = rows.slice(1).map(r =>
        Object.fromEntries(headers.map((h, i) => [h, r[i] ?? '']))
      );

      render(items);
      lastUpdateT = Date.now();
      updated.textContent = `Updated ${new Date(lastUpdateT).toLocaleString()}`;
      saveCache(items);
      offlineBadge.style.display = 'none';
    } catch (e) {
      const cached = loadCached();
      if (cached) {
        render(cached.items);
        updated.textContent = `Offline â€” last update ${new Date(cached.t).toLocaleString()}`;
        offlineBadge.style.display = 'block';
      } else {
        updated.textContent = 'Failed to load data';
      }
    }
  }

  fetchAndRender();
  setInterval(fetchAndRender, REFRESH_MS);
  </script>
</body>
</html>
